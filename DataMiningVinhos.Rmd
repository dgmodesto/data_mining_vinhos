---
title: "AnaliseQualidadeVinhos"
output: html_document
---

# Modelo preditivo de qualidade de vinho

Nos últimos anos o setores de vinícola e tecnologia estão sendo foco de diversos tipos de desenvolvimento. Será apresentado neste trabalho a aplicação de análises exploratórias dos dados de vinhos utilizando a linguagem R. O objetivo é abordar alguns dos  pressupostos que interligam o setor vinícola com técnicas específicas de data mining e verificar até que ponto esta interligação pode melhorar a tomada de decisão.

#### 1. Instalação das bibliotecas

```{r setup, include=FALSE}

# install.packages("dplyr")
# install.packages('readr')
# install.packages('plotly')
# install.packages("corrgram")
# install.packages('ggplot2')
# install.packages('gmodels')
# install.packages('psych')
# install.packages("corrplot")
# install.packages('tree')
# install.packages('party')

# library('dplyr')
library('readr')
library('plotly')
library('ggplot2')
library('gmodels')
library('psych')
library('corrgram')
library('corrplot')
library('tree')
library('party')

# options( warn = -1 )
```


#### 2. Carregando a base de dados


```{r echo=FALSE}

base = read.csv2("data/base.csv")
options("scipen" = 2)

head(base, n=4) 

```

#### 3. Preparação dos dados

** 3.1. Tipo de variáveis**

Identificando o tipo de cada variável do dataset.

```{r echo=FALSE}

classes <- c(class(base$id_vinho),class(base$fixedacidity),class(base$volatileacidity)
,class(base$citricacid)
,class(base$residualsugar)
,class(base$chlorides)
,class(base$freesulfurdioxide)
,class(base$totalsulfurdioxide)
,class(base$density)
,class(base$pH)
,class(base$sulphates)
,class(base$alcohol)
,class(base$quality)
,class(base$Vinho))

classes

```

Identica-se que a variável Vinho é a única categórica, necessitando posteriormente convertê-la em númerica para aplicar um modelo preditivo se necessário.

** 3.2. Tratamento das variáveis **

**3.2.1. Variáveis nulas**

A partir do comando *sum*, contabilizamos a quantidade total de variáveis nulas dentro do dataset. Caso o retorno da constabilização seja diferente de 0, necessita-se aplicar algum tratamento para essas variáveis.
```{r echo=FALSE}
sum(is.na(base))

```
** 3.2.2. Transformação dos dados **

Ao identificar uma variável categórica, converte-se para binária para que algoritmos como **Regressão Linear** sejam possíveis de trabalhar.

 * 0 - RED
 * 1 - WHITE
 
```{r echo=FALSE}
base$Vinho = c(0,1)[as.numeric(base$Vinho)]

head(base)

```

Apresentação da quantidade de registros de Vinhos Tintos e Brancos
```{r echo=FALSE}

ggplot(base,aes(x=Vinho,fill=factor(Vinho)))+geom_bar(stat = "count",position = "dodge")+
  scale_x_continuous(breaks = seq(0,1,1))+
  ggtitle("Classificaçao dos Vinhos (0 - Red/ 1 -Branco)")+
  theme_classic()

```

*** 2.2.3. Normalização Min-Max***

Transformação dos dados numéricos onde os dados são normalizados gerando valores entre  0 a 1.

```{r}

```


** 2.2.4. Detecção de Outliers **

Utilizando a regra IQR, detecta-se e remove todos os dados considerados outliers.


Rpresentação em boxplot das variáveis, identificando outliers nos seus valores.
```{r echo=FALSE}
teste <- base
teste$id_vinho <- NULL

boxplot(teste,col='gray',main='Wine quality values',xaxt = 'n',  xlab = '')
axis(1, labels = FALSE)
text(x =  seq_along(colnames(teste)), y = par("usr")[3] - 1, srt = 45, adj = 1,labels = colnames(teste), xpd = TRUE)

```

Aplicação do método IQR para identificação e remoção de outliers.
```{r}
vars <- c('fixedacidity','volatileacidity','citricacid','residualsugar','chlorides','freesulfurdioxide','totalsulfurdioxide','density','pH','sulphates','alcohol')
Outliers <- c()
for(i in vars){
    max <- quantile(base[,i],0.75, na.rm=TRUE) + (IQR(base[,i], na.rm=TRUE) * 1.5 )
    min <- quantile(base[,i],0.25, na.rm=TRUE) - (IQR(base[,i], na.rm=TRUE) * 1.5 )
    
    idx <- which(base[,i] < min | base[,i] > max)
    print(paste(i, length(idx), sep=''))
    Outliers <- c(Outliers, idx)
}
Outliers <- sort(Outliers)

base <- base[-Outliers,]
```


#### 4. Análise exploratória dos dados

```{r echo=FALSE}
summary(base)

```

**4.1. Qualidade do Vinho**

Através do gráfico em barras, identifica-se a distribuição das notas para os vinhos brancos e vermelhos.
```{r echo=FALSE}
ggplot(base,aes(x=quality))+geom_bar(stat = "count",position = "dodge")+
  scale_x_continuous(breaks = seq(1,10,1))+
  ggtitle("Distribuição da Qualidade de Vinhos")+
  theme_classic()

```

Observando, a média dos vinhos se encontram entre 5 e 6 na faixa de 3 a 9.


**4.2. Classificação do Vinho**

A variável qualidadeVinho é criado, classificando todos os vinhos acima da nota 5 em bons ou ruins, dependendo da sua nota de qualidade.
```{r echo=FALSE}


base$qualidadeVinho<-ifelse(base$quality>5,1,0)

ggplot(base,aes(x=qualidadeVinho,fill=factor(qualidadeVinho)))+geom_bar(stat = "count",position = "dodge")+
  scale_x_continuous(breaks = seq(0,1,1))+
  ggtitle("Classificaçao dos Vinhos (Bom/Ruim)")+
  theme_classic()

```

**4.3. Propriedades dos Vinhos**


Verificação da densidade dos vinhos, determinados em faixas.
```{r}
ggplot(base,aes(x=density,fill=factor(qualidadeVinho)))+geom_density(alpha=0.25)+
  geom_vline(aes(xintercept=mean(density[qualidadeVinho==0],na.rm=T)),color="red",linetype="dashed",lwd=1)+
  geom_vline(aes(xintercept=mean(density[qualidadeVinho==1],na.rm=T)),color="blue",linetype="dashed",lwd=1)+
  scale_x_continuous(breaks = seq(0.9,1.1,0.05))+
  xlab(label = "Densidade dos vinhos")+
  ggtitle("Distribuição da Densidade dos Vinhos")+
  theme_classic()
```

```{r}
ggplot(base,aes(x=alcohol,fill=factor(qualidadeVinho)))+geom_density(alpha=0.25)+
  geom_vline(aes(xintercept=mean(alcohol[qualidadeVinho==0],na.rm=T)),color="red",linetype="dashed",lwd=1)+
  geom_vline(aes(xintercept=mean(alcohol[qualidadeVinho==1],na.rm=T)),color="blue",linetype="dashed",lwd=1)+
  scale_x_continuous(breaks = seq(8,15,1))+
  xlab(label = "Nível de Álcool")+
  ggtitle("Distribuição do Nível de Álcool entre Vinhos")+
  theme_classic()
```
Explorando os plots que demonstram a classificação dos vinhos, ambos (branco e vermelho) são similares em suas propriedades,porém a propriedade álcool possui um valor discriminante para o vinho Branco. 



**4.5. Tabulação Cruzada**

Através da tabulação cruzada (CroosTable) verificamos a independência do fator.
Utilizamos o tipo "r" para visualizar a proporção de qualidade por cada grupo da variável álcool


```{r}
fx_alcohol <- cut(base$alcohol,breaks=c(0,5,10,15,max(base$alcohol)))  
str(base)
CrossTable(fx_alcohol , base$qualidadeVinho, type = "r")
```
Após análise dos resultados, identificamos que no grupo com a faixa entre 10 e 14 de álcool encontra-se a maior proporção de vinhos de qualidade. Portanto,a qualidade do vinho é diretamente relacionada com seu teor alcoólico.




**4.6. Mapa de Correlação**

Análise de correlação entre variáveis por método de Pearson, identificando as principais variáveis que influenciam a qualidade do vinho.

```{r echo=FALSE}

matcor <- cor(base)

panel.cor <- function(x, y, digits=2, prefix ="", cex.cor,
                      ...)  {
  usr <- par("usr")
  on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  r <- cor(x, y , use = "pairwise.complete.obs")
  txt <- format(c(r, 0.123456789), digits = digits) [1]
  txt <- paste(prefix, txt, sep = "")
  if (missing(cex.cor))
    cex <- 0.8/strwidth(txt)
  text(0.5, 0.5, txt, cex = cex * abs(r))
}

corrplot::corrplot(matcor, method="circle", order="hclust")

```
```{r}
head(base)
```

#### 5. Seleção de variáveis


Após separaçãó das bases, aplica-se o método Stepwise para a seleção de variáveis.

```{r}
modelo1 <- lm(quality ~ totalsulfurdioxide+freesulfurdioxide+residualsugar+citricacid+alcohol+id_vinho+pH+density+sulphates+fixedacidity+chlorides+volatileacidity+Vinho+qualidadeVinho, data=base)
```

```{r}
stepwise<-step(modelo1,direction="both")
stepwise
summary(stepwise)
```

Através do método stepwise, que aplica tanto a função forward quanto backward, mantemos 7 das 11 variáveis iniciais.


As variáveis selecionadas pelo stepwise e que possuem p-value próximo a 0 são selecionadas para serem aplicadas nos modelos. 
```{r}
base = select(base, freesulfurdioxide,residualsugar,alcohol,pH,
              density,sulphates,fixedacidity,volatileacidity,Vinho,
              quality,qualidadeVinho)

head(base)
```

Divisão da base da dados para treino e teste do modelo, sendo 70% das observações dedicados a treino e 30% para testes.

```{r}
attach(base)


## 70% do tamanho da base
smp_size <- floor(0.7 * nrow(base))

set.seed(42)
train_ind <- sample(seq_len(nrow(base)), size = smp_size)

train <- base[train_ind, ]


test <- base[-train_ind, ]
head(test)
```



#### 6. Aplicando os algoritmos

A nossa base de vinhos pode ser classificada tanto como um problema de Classificação quanto de Regressão. Iremos aplicar 3 algoritmos que possuem como objetivo classificar e dar a nota para um vinho, entre eles estão:

- Regressão Linear: previsão de nota
- Árvore de Decisão: classificação do vinho
- Regressão Logística : classificação de vinho


**6.1. Regressão Linear**

```{r}

#treinando o modelo
linear <- lm(quality ~
               freesulfurdioxide+residualsugar+alcohol+pH+density+sulphates+fixedacidity+volatileacidity+Vinho+qualidadeVinho, data=base)


```

Funções e análise do modelo.
```{r}

# Coeficiente
coefficients(linear) 
confint(linear, level=0.95)

#Prevendo valores
fitted(linear)

#Resíduos
residuals(linear) 


anova(linear)
vcov(linear) # matriz de covariancia
influence(linear)

layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page 
plot(linear)

```

**6.1.2. Cross Validation**

```{r}
# install.packages("DAAG")
library(DAAG)
cv.lm(data=base, linear, m=2) # 3 fold cross-validation

```


